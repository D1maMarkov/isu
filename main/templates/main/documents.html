{% extends "main/base.html" %}
{% load static %}
{% block content %}
<header>
  <h1>Система управления</h1>
  <div class="menu">
    <a href="/warehouse/materials/">Склад</a>
    <a href="/ceh/workers/">Цех</a>
    <a href="/docs/" class="active">Документация</a>
    <div class="avatar"><img src="{% static 'main/shutdown.png' %}" /></div>
  </div>
</header>
  <!-- Документация -->
  <main id="docs">
    <h2>Документация</h2>
    <div style="display: flex;">

      <div class="filters">
        <input type="text" placeholder="Поиск по ID заявки">
        <input type="text" placeholder="Поиск по номеру партии">

        <select>
          <option>Все категории</option>
          <option value="Заявка">Заявка</option>
          <option value="Задание">Задание</option>
          <option value="тех. Задание">тех. Задание</option>
          <option value="Заказ">Заказ</option>
        </select>
      </div>

      {% if request.user.role == "Генеральный директор" %}
      <button onclick="document.getElementById('dialog-confirm-add-batch').showModal()">Добавить партию</button>
      {% endif %}
    </div>
      <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
        <button title="Применить фильтры поиска к документам" onclick="filterDocs()">Поиск</button>
        <button title="Добавить новую заявку" onclick="openAddDoc(event)">Добавить</button>
        <button title="Редактировать существующую заявку по ID" onclick="document.getElementById('dialog-edit-doc-entry').showModal()">Изменить</button>
        <button title="Удалить заявку по ID с подтверждением" onclick="document.getElementById('dialog-delete-doc-id').showModal()">Удалить</button>
      </div>
        </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID заявки</th><th>Номер партии</th><th>Документ</th>
          <th>Дата загрузки</th><th>Категория</th><th>Результат</th><th>Обновлено</th>
        </tr>
      </thead>
      <tbody>
        {% for d in docs %}
        <tr>
          <td>{{ d.id }}</td><td>{{ d.batch }}</td><td><button title="Открыть загруженные документы заявки" onclick="openDoc(event, {{d.id}})">Открыть</button></td>
          <td>{{ d.created_at }}</td><td>{{ d.category }}</td><td><button title="Открыть результат заявки" onclick="openResults(event, {{d.id}})">Открыть</button></td><td>{{ d.updated_at }}</td>
          {% endfor %}
        </tr>
      </tbody>
    </table>
    <dialog id="dialog-z" class="custom-dialog">
      <div class="dialog-header">
        <h2>Загруженные документы</h2>
      </div>
      <div class="dialog-body">
        <div id="doc-section">
          <div class="uploaded-section">
            <a href="" target="_blank" title="Скачать документ" id="doc-name">Документ на согласование объёма выпуска</a>
            <button class="delete-doc-btn" onclick="removeUploadedRequest(event)">×</button>
          </div>
        <hr>
        </div>

        <p>Загрузите новую версию документа:</p>
        <input type="file" id="doc-input" accept=".doc,.docx">

        <div class="dialog-buttons">
          <button class="primary" onclick="sendDoc(event)">Отправить</button>
          <button onclick="this.closest('dialog').close()">Закрыть</button>
        </div>
      </div>
    </dialog>

    <dialog id="dialog-confirm-delete-docfile" class="custom-dialog">
      <div class="dialog-header">
        <h2>Подтверждение удаления</h2>
      </div>
      <div class="dialog-body">
        <p>Вы уверены, что хотите удалить этот документ?</p>
        <div class="dialog-buttons">
          <button onclick="confirmRemoveUploaded()">Да</button>
          <button onclick="document.getElementById('dialog-confirm-delete-docfile').close()">Нет</button>
        </div>
      </div>
    </dialog>


    <!-- Диалог для добавления заявки -->
    <dialog id="dialog-add-doc" class="custom-dialog">
      <div class="dialog-header">
        <h2>Добавление заявки</h2>
      </div>

      <form class="form-styled" onsubmit="addDoc(event)">
        <div class="form-field">
          <label for="add-doc-batch">Номер партии</label>
          <select id="add-doc-batch">

          </select>
        </div>

        <div class="form-field">
          <label for="add-doc-category">Категория</label>
          <select id="add-doc-category">
            <option>Заявка</option>
            <option>Задание</option>
            <option>тех. Задание</option>
            <option>Заказ</option>
          </select>
        </div>

        <div class="dialog-buttons">
          <button type="submit" class="primary">Добавить</button>
          <button type="button" onclick="this.closest('dialog').close()">Закрыть</button>
        </div>
      </form>
    </dialog>


    <!-- Подтверждение добавления заявки -->
    <dialog id="dialog-confirm-add-doc" class="custom-dialog">
      <div class="dialog-header">
        <h2>Подтверждение добавления</h2>
      </div>
      <div class="form-styled">
        <p>Вы уверены, что хотите добавить заявку: <strong id="confirm-add-doc-data"></strong>?</p>
        <div class="dialog-buttons">
          <button onclick="performAddDoc(event)">Да</button>
          <button onclick="this.closest('dialog').close()">Нет</button>
        </div>
      </div>
    </dialog>

    <!-- Подтверждение изменения заявки -->
    <dialog id="dialog-confirm-edit-doc" class="custom-dialog">
      <div class="dialog-header">
        <h2>Подтверждение изменения</h2>
      </div>
      <div class="form-styled">
        <p>Вы уверены, что хотите изменить заявку: <strong id="confirm-edit-doc-data"></strong>?</p>
        <div class="dialog-buttons">
          <button onclick="editDoc(event)">Да</button>
          <button onclick="this.closest('dialog').close()">Нет</button>
        </div>
      </div>
    </dialog>

    <dialog id="dialog-edit-doc-entry" class="custom-dialog">
      <div class="dialog-header">
        <h2>Редактирование записи</h2>
      </div>
      <form class="form-styled">
        <div class="form-field">
          <label for="edit-doc-id-input">Введите ID заявки</label>
          <input type="text" id="edit-doc-id-input" placeholder="Например, 0001">
        </div>
        <div class="dialog-buttons">
          <button type="button" onclick="openEditDoc(event)">Продолжить</button>
          <button type="button" onclick="this.closest('dialog').close()">Закрыть</button>
        </div>
      </form>
    </dialog>

    <!-- Диалог для редактирования заявки -->
    <dialog id="dialog-edit-doc" class="custom-dialog">
      <div class="dialog-header">
        <h2>Редактирование записи</h2>
      </div>
      <form class="form-styled" onsubmit="confirmEditDoc(event)">
        <div class="form-field">
          <label for="edit-doc-batch">Номер партии</label>
          <select id="edit-doc-batch"></select>
        </div>

        <div class="form-field">
          <label for="edit-doc-category">Категория</label>
          <select id="edit-doc-category">
            <option value="Задание">Задание</option>
            <option value="тех. Задание">тех. Задание</option>
            <option value="Заказ">Заказ</option>
            <option value="Заявка">Заявка</option>
          </select>
        </div>

        <div class="dialog-buttons">
          <button type="submit" class="primary">Сохранить</button>
          <button type="button" onclick="this.closest('dialog').close()">Закрыть</button>
        </div>
      </form>
    </dialog>

    <!-- Диалог: ввод ID заявки -->
<dialog id="dialog-delete-doc-id" class="custom-dialog">
  <div class="dialog-header">
    <h2>Удаление заявки</h2>
  </div>
  <form class="form-styled">
    <div class="form-field">
      <label for="delete-doc-id">Введите ID заявки</label>
      <input type="text" id="delete-doc-id" placeholder="Например, 0001">
    </div>
    <div class="dialog-buttons">
      <button type="button" onclick="confirmDeleteDoc(event)">Удалить</button>
      <button type="button" onclick="this.closest('dialog').close()">Закрыть</button>
    </div>
  </form>
</dialog>

<!-- Подтверждение добавления партии -->
<dialog id="dialog-confirm-add-batch" class="custom-dialog">
  <div class="dialog-header">
    <h2>Подтверждение добавления партии</h2>
  </div>
  <div class="form-styled">
    <p>Вы уверены, что хотите добавить партию?</p>
    <div class="dialog-buttons">
      <button onclick="createBatch(event)">Да</button>
      <button onclick="this.closest('dialog').close()">Нет</button>
    </div>
  </div>
</dialog>

<!-- Подтверждение удаления заявки -->
<dialog id="dialog-confirm-delete-doc" class="custom-dialog">
  <div class="dialog-header">
    <h2>Подтверждение удаления</h2>
  </div>
  <div class="form-styled">
    <p>Вы уверены, что хотите удалить заявку с ID: <strong id="confirm-delete-doc-id"></strong>?</p>
    <div class="dialog-buttons">
      <button onclick="performDeleteDoc(event)">Да</button>
      <button onclick="document.getElementById('dialog-confirm-delete-doc').close()">Нет</button>
    </div>
  </div>
</dialog>
  </main>
  </section>

  <dialog id="dialog-r" class="custom-dialog">
    <div class="dialog-header">
      <h2>Загруженные документы</h2>
    </div>
    <div class="dialog-body">
      <div id="doc-results">
        <div id="result-files">
          <div class="uploaded-section">
            <a href="#" target="_blank" title="Скачать документ">Результат анализа производственного процесса</a>
            <button class="delete-doc-btn" onclick="removeUploadedDoc(event)">×</button>
          </div>
        </div>

        <hr>
      </div>

      <p>Загрузите новый результат заявки:</p>
      <input type="file" id="result-input" accept=".doc,.docx">

      <div class="dialog-buttons">
        <button class="primary" onclick="sendResult(event)">Отправить</button>
        <button onclick="this.closest('dialog').close()">Закрыть</button>
      </div>
    </div>
  </dialog>

  <script>
    let openResultsDocId = null;
    let pendingEditDoc = null;

    function confirmEditDoc(event){
      event.preventDefault();
      pendingEditDoc = {
        category: document.getElementById('edit-doc-category').value,
        batch: document.getElementById('edit-doc-batch').value
      }

      document.getElementById('confirm-edit-doc-data').textContent = `
        Категория: ${pendingEditDoc.category},
        Партия: ${pendingEditDoc.batch}
      `;

      document.getElementById('dialog-confirm-edit-doc').showModal();
    }
    function openResults(event, id){
      event.preventDefault();

      fetch(`/docs/get/${id}/`).then(
        response => response.json()
      ).then(
        response => response.document
      ).then(d => {
        let docsHTML = '';
        console.log(d)
        d.results.forEach(r => {
          docsHTML += `<div class="uploaded-section">
            <a href="${r.url}" target="_blank" title="Скачать документ">${r.name}</a>
            <button class="delete-doc-btn" onclick="removeUploadedDoc(event, ${r.id})">×</button>
          </div>`
        })
        if (docsHTML.length > 0){
          docsHTML += '<hr>';
        }
        openResultsDocId = id;
        document.getElementById("doc-results").innerHTML = docsHTML;
        document.getElementById("dialog-r").showModal();
      })
    }
    let sendDocDocId = null;

    function sendResult(event){
      event.preventDefault();
      const fileInput = document.getElementById('result-input');
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      fetch(`/docs/${openResultsDocId}/add-result/`, {
        method: "POST",
        body: formData
      }).then(response => {
        if (response.ok){
          alert("Результат добавлен!");
          document.getElementById("dialog-r").close();
        }
      })
    }

    function removeUploadedRequest(event, id){
      event.preventDefault();
      fetch(`/docs/delete-request/${id}/`, {
        method: "DELETE"
      }).then(response => {
        if (response.ok){
          alert("Документ удалён!");
          document.getElementById("dialog-z").close()
        }
      })
    }

    function openDoc(event, id){
      fetch(`/docs/get/${id}/`).then(
        response => response.json()
      ).then(r => {
        const d = r.document;
        sendDocDocId = d.id;
        if (d.request !== undefined && d.request !== null){
          document.getElementById("doc-section").innerHTML = `
              <div class="uploaded-section">
                <a href="${d.request_url}" target="_blank" title="Скачать документ" id="doc-name">${d.request_name}</a>
                <button class="delete-doc-btn" onclick="removeUploadedRequest(event, ${d.id})">×</button>
              </div>
              <hr>
          `
        }
        else{
          document.getElementById("doc-section").innerHTML = ``;
        }
        document.getElementById('dialog-z').showModal();
      })
    }

    function sendDoc(event){
      const fileInput = document.getElementById('doc-input');
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      // Отправляем файл на сервер
      fetch(`/docs/edit/${sendDocDocId}/`, {
          method: 'POST',
          body: formData,
      })
      .then(response => {
          if (response.ok) {
              document.getElementById('dialog-z').close();
          }
          else{
            throw new Error('Network response was not ok.');
          }
      })
      .then(data => {
          alert('Файл успешно загружен!');
      })
      .catch(error => {
          console.error('Ошибка:', error);
          alert('Произошла ошибка при загрузке файла.');
      });
    }


    let deleteDocId = null;

    function confirmDeleteDoc(event){
      event.preventDefault();
      const id = document.getElementById("delete-doc-id").value.trim();

      fetch(`/docs/get/${id}/`).then(response => {
        if (response.status == 404){
          return alert("Документ с ID не найден")
        }
        if (response.status == 200){
          deleteDocId = id;

          document.getElementById("confirm-delete-doc-id").textContent = id;
          document.getElementById("dialog-confirm-delete-doc").showModal();
        }
      })
    }
  let pendigAddDoc = null;

  function openAddDoc(event){
    event.preventDefault();

    document.getElementById('dialog-add-doc').showModal();
    let selectHTML = '';
    fetch(`/batch/all/`).then(response => response.json()).then(response => response.batches).then(batches => {
      batches.forEach(b => {
        selectHTML += `<option value="${b.id}" >${b.name}</option>`
      })
      document.getElementById('add-doc-batch').innerHTML = selectHTML;
    })
  }

  function addDoc(event){
    event.preventDefault();
    const batch = document.getElementById("add-doc-batch").value.trim();
    const category = document.getElementById("add-doc-category").value.trim();

    pendigAddDoc = {
      batch: batch,
      category: category
    }

    document.getElementById('confirm-add-doc-data').textContent = `
      Партия: ${batch},
      Категория: ${category}
    `;

    document.getElementById("dialog-confirm-add-doc").showModal();
  }

  function performAddDoc(event){
    event.preventDefault()

    fetch(`/docs/add/`, {
      method: "POST",
      body: JSON.stringify(pendigAddDoc)
    }).then(response => {
      if (response.status == 201){
        response.json().then(r => {
          d = r.document;
          const tbody = document.querySelector("tbody");
          const row = document.createElement("tr");
          row.innerHTML = `<td>${d.id}</td><td>${d.batch}</td><td><button title="Открыть загруженные документы заявки" onclick="document.getElementById('dialog-z').showModal()">Открыть</button><td>${d.created_at}</td><td>${d.category}</td><td><button title="Открыть результаты заявки" onclick="document.getElementById('dialog-z').showModal()">Открыть</button><td>${d.updated_at}</td>`;
          tbody.prepend(row);
          document.getElementById('dialog-add-doc').querySelector('form').reset();
          document.getElementById('dialog-add-doc').close()
          document.getElementById('dialog-confirm-add-doc').close()
        })
      }
      if (response.status == 404){
        response.json().then(r => {
          return alert(r.message)
        })
      }
    })
  }

  function createBatch(event){
    event.preventDefault();

    fetch(`/batch/add/`, {
      method: "POST",
    }).then(response => {
      if (response.ok){
        response.json().then(response => {
          const b = response.batch;
          document.getElementById("dialog-confirm-add-batch").close();
          alert(`Новая партия № ${b.id} добавлена!`)
        })
      }
    })
  }

  function editDoc(event) {
    event.preventDefault();
    const id = document.getElementById('edit-doc-id-input').value.trim();

    pendingEditDoc = {
      category: document.getElementById('edit-doc-category').value,
      batch: document.getElementById('edit-doc-batch').value
    }
    fetch(`/docs/edit/${id}/`, {
      method: "POST",
      body: JSON.stringify(pendingEditDoc)
    }).then(response => {
        if (response.ok){
          document.getElementById('dialog-confirm-edit-doc').close();
          document.getElementById('dialog-edit-doc-entry').querySelector('form').reset();
          document.getElementById('dialog-edit-doc-entry').close();
          document.getElementById("dialog-edit-doc").close()

          const rows = document.querySelectorAll('tbody tr');
          rows.forEach(r => {
            if (+r.cells[0].textContent === +id){
              r.cells[1].textContent = pendingEditDoc.batch;
              r.cells[4].textContent = pendingEditDoc.category;
            }
          })
        }
      })
  }

  function openEditDoc(event) {
  const id = document.getElementById('edit-doc-id-input').value.trim();
  fetch(`/docs/get/${id}/`).then(response => {
    if (response.status == 404){
      alert("Документа с ID не найден")
    }
    if (response.status == 200){
      response.json().then(response => response.document).then(d => {
        fetch(`/batch/all/`).then(response => response.json()).then(response => response.batches).then(
          batches => {
            let selectHTML = '';
            console.log(batches)
            console.log(d)
            batches.forEach(b => {
              selectHTML += `
              <option value=${b.id} ${b.id == d.batch ? 'selected' : ''}>${b.name}</option>
              `
            })
            document.getElementById('edit-doc-batch').innerHTML = selectHTML;
          }
        )
        document.getElementById("edit-doc-category").value = d.category
      })
    }
  })

  // Здесь можешь подключить подгрузку данных по ID
  document.getElementById('dialog-edit-doc-entry').close();
  document.getElementById('dialog-edit-doc').showModal();
}



function removeUploadedDoc(event, id) {
  event.preventDefault();
  fetch(`/docs/results/delete/${id}/`, {
    method: "DELETE"
  }).then(response => {
    if (response.ok){
      alert("Результат удалён!")
      document.getElementById("dialog-r").close();
    }
  })
}


function performDeleteDoc(event) {
  event.preventDefault();
  const id = document.getElementById('confirm-delete-doc-id').textContent;
  console.log(`Удаление заявки с ID: ${id}`);
  document.getElementById('dialog-confirm-delete-doc').close();
  fetch(`/docs/delete/${id}/`, {method: "DELETE"}).then(response => {
    if (response.status == 203){
      alert(`Документ с ID ${id} удален.`);
      const rows = document.querySelectorAll("tr");
      rows.forEach(r => {
        if (+r.cells[0].textContent === +id){
          r.remove()
        }
      })
      document.getElementById('dialog-delete-doc-id').close()
    }
  })
}

let pendingDocToDelete = null;

function confirmRemoveUploaded() {
  if (pendingDocToDelete) {
    pendingDocToDelete.remove();
    pendingDocToDelete = null;
  }
  document.getElementById('dialog-confirm-delete-docfile').close();
}

let currentEditRow = null;


let pendingAdd = {};

let pendingEdit = {};
    function filterDocs(){
      const id = document.querySelector(".filters").children[0].value;
      const batch = document.querySelector(".filters").children[1].value;
      const category = document.querySelector(".filters").children[2].value;

      fetch(`/docs/filter/?id=${id}&batch=${batch}&category=${category === 'Все категории' ? '' : category}`).then(response => {
        if (response.status == 200){
          response.json().then(response => {
            const tbody = document.querySelector('tbody');
            tbody.innerHTML = '';
            response.documents.forEach(d => {
              const row = document.createElement("tr");
              row.innerHTML = `<td>${d.id}</td><td>${d.batch}</td><td><button title="Открыть загруженные документы заявки" onclick="document.getElementById('dialog-z').showModal()">Открыть</button><td>${d.created_at}</td><td>${d.category}</td><td><button title="Открыть результаты заявки" onclick="document.getElementById('dialog-z').showModal()">Открыть</button><td>${d.updated_at}</td>`;
              tbody.appendChild(row)
            })
          })
        }
      })
    }
  </script>
{% endblock %}
