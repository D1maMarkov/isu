{% extends "main/base.html" %}
{% load static %}
{% block content %}
<header>
  <h1>Система управления</h1>
  <div class="menu">
    <a href="/warehouse/materials/" class="active">Склад</a>
    <a href="/ceh/workers/">Цех</a>
    <a href="/docs/">Документация</a>
    <div class="avatar"><img src="{% static 'main/shutdown.png' %}" /></div>
  </div>
</header>

   <!-- Подвкладки Склад -->
   <div class="submenu" id="submenu-sklad">
    <button data-target="materials"><a href="/warehouse/materials/">Материалы</a></button>
    <button data-target="products"><a href="/warehouse/products/">Готовые изделия</a></button>
    <button data-target="overuse" class="active"><a href="/warehouse/overuse/">Перерасход</a></button>
  </div>

  <!-- Склад -->


  <!-- Диалог: удаление ввод ID -->

  <section id="sklad">
<div class="table-section" id="overuse">
  <h2>Перерасход</h2>

  <div class="filters">
    <input type="text" id="filter-over-batch" placeholder="Номер партии">
    <input type="text" id="filter-over-material" placeholder="ID материала">
  </div>

  <div class="material-actions">
    <button onclick="filterOvers()">Поиск</button>
    <button onclick="document.getElementById('dialog-add-over').showModal()">Добавить строку</button>
    <button onclick="document.getElementById('dialog-edit-over').showModal()">Изменить строку</button>
    <button onclick="document.getElementById('dialog-delete-over').showModal()">Удалить строку</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Номер партии</th>
        <th>ID материала</th>
        <th>Количество</th>
      </tr>
    </thead>
    <tbody id="over-table-body">
      {% for o in overs %}
        <tr><td>{{ o.id }}</td><td>{{ o.batch }}</td><td>{{ o.material}}</td><td>{{ o.quantity }}</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Добавление -->
  <dialog id="dialog-add-over" class="custom-dialog">
    <div class="dialog-header"><h2>Добавить строку</h2></div>
    <form class="form-styled" onsubmit="addOverRow(event)">
      <div class="form-field"><label>Номер партии</label>
        <select id="add-over-batch">
          {% for b in batches %}
          <option value="{{ b.id }}">{{ b }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-field">
        <label>ID материала</label>
        <select id="add-over-material">
          {% for m in materials %}
          <option value="{{ m.id }}">{{ m }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-field"><label>Количество</label><input type="number" id="add-over-qty" required></div>
      <div class="dialog-buttons">
        <button class="primary" type="submit">Добавить</button>
        <button type="button" onclick="this.closest('dialog').close()">Закрыть</button>
      </div>
    </form>
  </dialog>

  <!-- Изменение -->
  <dialog id="dialog-edit-over" class="custom-dialog">
    <div class="dialog-header"><h2>Изменить строку</h2></div>
    <form class="form-styled" onsubmit="editOverRow(event)">
      <div class="form-field"><label>ID</label><input type="text" id="edit-over-id" required></div>
      <label>Материал</label>
      <div class="form-field">
        <select id="edit-over-material">
          {% for m in materials %}
            <option value="{{ m.id }}">{{ m }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-field"><label>Новое количество</label><input type="number" id="edit-over-qty" required></div>
      <div class="dialog-buttons">
        <button class="primary" type="submit">Сохранить</button>
        <button type="button" onclick="this.closest('dialog').close()">Закрыть</button>
      </div>
    </form>
  </dialog>

  <!-- Удаление -->
  <dialog id="dialog-delete-over" class="custom-dialog">
    <div class="dialog-header"><h2>Удалить строку</h2></div>
    <form class="form-styled">
      <div class="form-field">
        <label for="delete-over-id">Введите ID строки</label>
        <input type="text" id="delete-over-id" placeholder="Например, 002" required>
      </div>
      <div class="dialog-buttons">
        <button type="button" onclick="confirmDeleteOver()">Удалить</button>
        <button type="button" onclick="this.closest('dialog').close()">Отмена</button>
      </div>
    </form>
  </dialog>

  <!-- Подтверждение удаления -->
  <dialog id="dialog-confirm-delete-over" class="custom-dialog">
    <div class="dialog-header"><h2>Подтверждение удаления</h2></div>
    <div class="form-styled">
      <p>Удалить запись с ID <strong id="confirm-over-id"></strong>?</p>
      <div class="dialog-buttons">
        <button onclick="performDeleteOver()">Да</button>
        <button onclick="document.getElementById('dialog-confirm-delete-over').close()">Нет</button>
      </div>
    </div>
  </dialog>
</div>

<!-- Подтверждение добавления -->
<dialog id="dialog-confirm-add-over" class="custom-dialog">
  <div class="dialog-header"><h2>Подтверждение добавления</h2></div>
  <div class="form-styled">
    <p>Добавить строку: <strong id="confirm-add-data"></strong>?</p>
    <div class="dialog-buttons">
      <button onclick="performAddOver()">Да</button>
      <button onclick="document.getElementById('dialog-confirm-add-over').close()">Нет</button>
    </div>
  </div>
</dialog>

<!-- Подтверждение изменения -->
<dialog id="dialog-confirm-edit-over" class="custom-dialog">
  <div class="dialog-header"><h2>Подтверждение изменения</h2></div>
  <div class="form-styled">
    <p>Изменить строку: <strong id="confirm-edit-data"></strong>?</p>
    <div class="dialog-buttons">
      <button onclick="performEditOver()">Да</button>
      <button onclick="document.getElementById('dialog-confirm-edit-over').close()">Нет</button>
    </div>
  </div>
</dialog>


  </section>

  <script>
function confirmDeleteOver() {
  const id = document.getElementById('delete-over-id').value.trim();
  const rows = document.querySelectorAll('#over-table-body tr');
  let found = false;

  fetch(`/overs/get/${id}`).then(response => {
    if (response.status == 404){
      return alert("Запись не найдена.");
    }
    if (response.status == 200){
      document.getElementById('dialog-delete-over').close();
      document.getElementById('confirm-over-id').textContent = id;
      document.getElementById('dialog-confirm-delete-over').showModal();
    }
  })
}

function performDeleteOver() {
  const id = document.getElementById('confirm-over-id').textContent;
  const rows = document.querySelectorAll('#over-table-body tr');
  rows.forEach(row => {
    if (row.cells[0].textContent == id) {
      row.remove();
    }
  });

  document.getElementById('dialog-confirm-delete-over').close();
  fetch(`/overs/delete/${id}`, {method: "DELETE"})
}

let pendingAdd = {};

function addOverRow(e) {
  e.preventDefault();

  const select = document.getElementById('add-over-material');
  pendingAdd.batch = document.getElementById('add-over-batch').value;
  pendingAdd.mat = select.value;
  pendingAdd.qty = document.getElementById('add-over-qty').value;

  document.getElementById('confirm-add-data').textContent =
    `Партия: ${pendingAdd.batch}, Материал: ${select.querySelectorAll("option")[select.selectedIndex].textContent}, Кол-во: ${pendingAdd.qty}`;

  document.getElementById('dialog-confirm-add-over').showModal();
}

function performAddOver() {
  const tbody = document.getElementById('over-table-body');
  const row = document.createElement('tr');
  fetch(`/overs/add/`, {
    method: "POST",
    body: JSON.stringify({
      batch: document.getElementById('add-over-batch').value,
      material: document.getElementById('add-over-material').value,
      quantity: document.getElementById('add-over-qty').value
    })
  }).then(response => {
    if (response.status == 201){
      response.json().then(o => {
        row.innerHTML = `<td>${o.id}</td><td>${o.batch}</td><td>${o.material}</td><td>${o.quantity}</td>`;
        tbody.prepend(row);

        document.getElementById('dialog-confirm-add-over').close();
        document.querySelector('#dialog-add-over form').reset();
        document.getElementById('dialog-add-over').close();
      })
    }
    if (response.status == 404){
      response.json().then(
        response => {
          console.log(response)
          return alert(response.message)
        }
      )
    }
  })
}

let pendingEdit = {};

function editOverRow(e) {
  e.preventDefault();
  const select = document.getElementById('edit-over-material');
  pendingEdit.id = document.getElementById('edit-over-id').value.trim();
  pendingEdit.qty = document.getElementById('edit-over-qty').value.trim();
  pendingEdit.material_id = select.value.trim();

  fetch(`/overs/get/${document.getElementById('edit-over-id').value.trim()}`).then(response => {
    if (response.status == 404){
      return alert("Запись не найдена.");
    }
    if (response.status == 200){
      document.getElementById('confirm-edit-data').textContent =
      `ID: ${pendingEdit.id}, Новое кол-во: ${pendingEdit.qty}, Новый материал: ${select.querySelectorAll("option")[select.selectedIndex].textContent}`;

      document.getElementById('dialog-confirm-edit-over').showModal();
    }
  })
}

function performEditOver() {
  const rows = document.querySelectorAll('#over-table-body tr');
  rows.forEach(row => {
    if (+row.cells[0].textContent === +pendingEdit.id) {
      row.cells[3].textContent = pendingEdit.qty;
    }
  });

  document.getElementById('dialog-confirm-edit-over').close();
  document.querySelector('#dialog-edit-over form').reset();
  document.getElementById('dialog-edit-over').close();
  fetch(`/overs/edit/${pendingEdit.id}/`, {
    method: "POST",
    body: JSON.stringify({
      quantity: pendingEdit.qty
    })
  })
}

function filterOvers() {
  const batch = document.querySelector(".filters").children[0].value;
  const material = document.querySelector(".filters").children[1].value;

  fetch(`/overs/filter/?batch=${batch}&material=${material}`).then(response => response.json()).then(response => {
    const tbody = document.getElementById('over-table-body');
    tbody.innerHTML = '';
    response.overs.forEach(o => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${o.id}</td><td>${o.batch}</td><td>${o.material}</td><td>${o.quantity}</td>`;
      tbody.appendChild(row);
    })
  })
}
  </script>
{% endblock %}
